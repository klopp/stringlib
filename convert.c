#include <string.h>
#include "convert.h"

static int a[] = { -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        /* '0' - '9' */
        0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
        /* */
        -1, -1, -1, -1, -1, -1, -1,
        /* 'A' - 'Z' */
        10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27,
        28, 29, 30, 31, 32, 33, 34, 35,
        /* */
        -1, -1, -1, -1, -1, -1,
        /* 'a' - 'z' */
        10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27,
        28, 29, 30, 31, 32, 33, 34, 35,
        /* */
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1 };

#define BASE_MAX    36

unsigned long asc2num(const char * s, unsigned base, int ignore_errors) {
    size_t size = 0;
    const char * ptr = s;
    if (base < 2 || base > BASE_MAX || !s || !*s)
        return -1;

    while (*ptr) {
        if (a[*ptr & 0xFF] == -1) {
            if (ignore_errors) {
                break;
            }
            else {
                return -1;
            }
        }
        ptr++;
        size++;
    }

    return size ? _asc2num(s, base, size) : -1;
}

unsigned long _asc2num(const char * s, unsigned base, size_t size) {

    unsigned p = 1;
    size_t i = 1;
    unsigned long rc = 0;

    size = (size ? size : strlen(s) );

    while( i++ < size )
    {
        p *= base;
    }

    while (size) {
        rc += a[*s & 0xFF] * p;
        p /= base;
        size--;
        s++;
    }

    return rc;
}

