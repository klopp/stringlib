#include <string.h>
#include "convert.h"

static int a[] = { -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        /* '0' - '9' */
        0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
        /* */
        -1, -1, -1, -1, -1, -1, -1,
        /* 'A' - 'Z' */
        10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27,
        28, 29, 30, 31, 32, 33, 34, 35,
        /* */
        -1, -1, -1, -1, -1, -1,
        /* 'a' - 'z' */
        10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27,
        28, 29, 30, 31, 32, 33, 34, 35,
        /* */
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1 };

static unsigned long long b[36][12] = { { 0 }, { 0 },
/* 2 */
{ 0, 0, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024 },
/* 3 */
{ 0, 0, 3, 9, 27, 81, 243, 729, 2187, 6561, 19683, 59049 },
/* 4 */
{ 0, 0, 4, 16, 64, 256, 1024, 4096, 16384, 65536, 262144, 1048576 },
/* 5 */
{ 0, 0, 5, 25, 125, 625, 3125, 15625, 78125, 390625, 1953125, 9765625 },
/* 6 */
{ 0, 0, 6, 36, 216, 1296, 7776, 46656, 279936, 1679616, 10077696, 60466176 },
/* 7 */
{ 0, 0, 7, 49, 343, 2401, 16807, 117649, 823543, 5764801, 40353607, 282475249 },
/* 8 */
{ 0, 0, 8, 64, 512, 4096, 32768, 262144, 2097152, 16777216, 134217728,
        1073741824 },
/* 9 */
{ 0, 0, 9, 81, 729, 6561, 59049, 531441, 4782969, 43046721, 387420489,
        3486784401 },
/* 10 */
{ 0, 0, 10, 100, 1000, 10000, 100000, 1000000, 10000000, 100000000, 1000000000,
        10000000000 },
/* 11 */
{ 0, 0, 11, 121, 1331, 14641, 161051, 1771561, 19487171, 214358881, 2357947691,
        25937424601 },
/* 12 */
{ 0, 0, 12, 144, 1728, 20736, 248832, 2985984, 35831808, 429981696, 5159780352,
        61917364224 },
/* 13 */
{ 0, 0, 13, 169, 2197, 28561, 371293, 4826809, 62748517, 815730721, 10604499373,
        137858491849 },
/* 14 */
{ 0, 0, 14, 196, 2744, 38416, 537824, 7529536, 105413504, 1475789056,
        20661046784, 289254654976 },
/* 15 */
{ 0, 0, 15, 225, 3375, 50625, 759375, 11390625, 170859375, 2562890625,
        38443359375, 576650390625 },
/* 16 */
{ 0, 0, 16, 256, 4096, 65536, 1048576, 16777216, 268435456, 4294967296,
        68719476736, 1099511627776 },
/* 17 */
{ 0, 0, 17, 289, 4913, 83521, 1419857, 24137569, 410338673, 6975757441,
        118587876497, 2015993900449 },
/* 18 */
{ 0, 0, 18, 324, 5832, 104976, 1889568, 34012224, 612220032, 11019960576,
        198359290368, 3570467226624 },
/* 19 */
{ 0, 0, 19, 361, 6859, 130321, 2476099, 47045881, 893871739, 16983563041,
        322687697779, 6131066257801 },
/* 20 */
{ 0, 0, 20, 400, 8000, 160000, 3200000, 64000000, 1280000000, 25600000000,
        512000000000, 10240000000000 },
/* 21 */
{ 0, 0, 21, 441, 9261, 194481, 4084101, 85766121, 1801088541, 37822859361,
        794280046581, 16679880978201 },
/* 22 */
{ 0, 0, 22, 484, 10648, 234256, 5153632, 113379904, 2494357888, 54875873536,
        1207269217792, 26559922791424 },
/* 23 */
{ 0, 0, 23, 529, 12167, 279841, 6436343, 148035889, 3404825447, 78310985281,
        1801152661463, 41426511213649 },
/* 24 */
{ 0, 0, 24, 576, 13824, 331776, 7962624, 191102976, 4586471424, 110075314176,
        2641807540224, 63403380965376 },
/* 25 */
{ 0, 0, 25, 625, 15625, 390625, 9765625, 244140625, 6103515625, 152587890625,
        3814697265625, 95367431640625 },
/* 26 */
{ 0, 0, 26, 676, 17576, 456976, 11881376, 308915776, 8031810176, 208827064576,
        5429503678976, 141167095653376 },
/* 27 */
{ 0, 0, 27, 729, 19683, 531441, 14348907, 387420489, 10460353203, 282429536481,
        7625597484987, 205891132094649 },
/* 28 */
{ 0, 0, 28, 784, 21952, 614656, 17210368, 481890304, 13492928512, 377801998336,
        10578455953408, 296196766695424 },
/* 29 */
{ 0, 0, 29, 841, 24389, 707281, 20511149, 594823321, 17249876309, 500246412961,
        14507145975869, 420707233300201 },
/* 30 */
{ 0, 0, 30, 900, 27000, 810000, 24300000, 729000000, 21870000000, 656100000000,
        19683000000000, 590490000000000 },
/* 31 */
{ 0, 0, 31, 961, 29791, 923521, 28629151, 887503681, 27512614111, 852891037441,
        26439622160671, 819628286980801 },
/* 32 */
{ 0, 0, 32, 1024, 32768, 1048576, 33554432, 1073741824, 34359738368,
        1099511627776, 35184372088832, 1125899906842624 },
/* 33 */
{ 0, 0, 33, 1089, 35937, 1185921, 39135393, 1291467969, 42618442977,
        1406408618241, 46411484401953, 1531578985264449 },
/* 34 */
{ 0, 0, 34, 1156, 39304, 1336336, 45435424, 1544804416, 52523350144,
        1785793904896, 60716992766464, 2064377754059776 },
/* 35 */
{ 0, 0, 35, 1225, 42875, 1500625, 52521875, 1838265625, 64339296875,
        2251875390625, 78815638671875, 2758547353515625 },
/* 36 */
{ 0, 0, 36, 1296, 46656, 1679616, 60466176, 2176782336, 78364164096,
        2821109907456, 101559956668416, 3656158440062976 },

};

#define BASE_MAX    36
#define LENGTH_MAX  10

unsigned long long asc2num(const char * s, unsigned base, int ignore_errors) {
    size_t size = 0;
    const char * ptr = s;
    if (base < 2 || base > BASE_MAX || !s || !*s)
        return -1;

    while (*ptr) {
        if (a[*ptr & 0xFF] == -1) {
            if (ignore_errors) {
                break;
            }
            else {
                return -1;
            }
        }
        ptr++;
        size++;
    }

    return size ? _asc2num(s, base, size) : -1;
}

unsigned long long _asc2num(const char * s, unsigned base, size_t size) {

    unsigned long long p = 1;
    unsigned long long rc = 0;

    const char * ptr = s + (size ? size : strlen(s));
    do {
        int c = a[*(--ptr) & 0xFF];
        if (c == -1)
            return rc;
        rc += c * p;
        p *= base;
    } while (ptr >= s);

    /*
     size = (size ? size : strlen(s));
     if (size <= LENGTH_MAX) {
     p = b[base][size];
     }
     else {
     size_t i = 1;
     while (i++ < size) {
     p *= base;
     }
     }
     while (size) {
     rc += a[*s & 0xFF] * p;
     p /= base;
     size--;
     s++;
     }
     */
    return rc;
}

